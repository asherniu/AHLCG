<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arkham Investigator Picker</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css">

</head>
<body>

<header>
  <h1>Arkham Investigator Picker</h1>
  <p>Random selection</p>
  <div class="divider"></div>
</header>

<div class="main-layout">
  <div class="panel">

    <!-- Player count -->
    <div class="player-row">
      <label>Players</label>
      <div class="player-btns">
        <button class="player-btn active" data-n="1" onclick="setPlayers(1)">1</button>
        <button class="player-btn"        data-n="2" onclick="setPlayers(2)">2</button>
        <button class="player-btn"        data-n="3" onclick="setPlayers(3)">3</button>
        <button class="player-btn"        data-n="4" onclick="setPlayers(4)">4</button>
      </div>
    </div>

    <!-- Results -->
    <div class="results-grid" id="resultsGrid"></div>

    <!-- Confirm/Redo bar — hidden until a pending pick exists -->
    <div class="confirm-bar" id="confirmBar">
      <span>Lock in these investigators?</span>
      <button class="btn-redo" onclick="redoPick()">↺ Redo all</button>
      <button class="btn-confirm" onclick="confirmPick()">✓ Confirm</button>
    </div>

    <!-- Stats -->
    <div class="stats">
      <span><strong id="statRemaining">—</strong>Remaining</span>
      <span><strong id="statPicked">—</strong>Picked</span>
      <span><strong id="statTotal">—</strong>Total</span>
    </div>
    <div class="progress-bar-wrap">
      <div class="progress-bar" id="progressBar" style="width:0%"></div>
    </div>

    <!-- Actions -->
    <div class="btn-row">
      <button class="btn-pick" id="btnPick" onclick="pickInvestigators()">Pick Investigator</button>
      <button class="btn-reset" onclick="resetPicks()">↺ Reset</button>
    </div>

  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header"><span>Full Roster</span></div>
    <div class="filter-row">
      <input type="text" id="filterInput" placeholder="Filter investigators…" oninput="renderList()" />
    </div>
    <div class="char-list" id="charList"></div>
  </div>
</div>

<script>
  // ── DATA ─────────────────────────────────────────────────────────────────────
  // Edit this array to add/remove investigators.
  // Classes: Guardian, Seeker, Rogue, Mystic, Survivor, Neutral
  const INVESTIGATORS_DATA = [
  { "name": "Roland Banks",       "role": "The Fed",                    "class": "Guardian", "expansion": "Core Set" },
  { "name": "Daisy Walker",       "role": "The Librarian",              "class": "Seeker",   "expansion": "Core Set" },
  { "name": "Skids OToole",       "role": "The Ex-Con",                 "class": "Rogue",    "expansion": "Core Set" },
  { "name": "Agnes Baker",        "role": "The Waitress",               "class": "Mystic",   "expansion": "Core Set" },
  { "name": "Wendy Adams",        "role": "The Urchin",                 "class": "Survivor", "expansion": "Core Set" },
  { "name": "Zoey Samaras",       "role": "The Chef",                   "class": "Guardian", "expansion": "The Dunwich Legacy" },
  { "name": "Rex Murphy",         "role": "The Reporter",               "class": "Seeker",   "expansion": "The Dunwich Legacy" },
  { "name": "Jenny Barnes",       "role": "The Dilettante",             "class": "Rogue",    "expansion": "The Dunwich Legacy" },
  { "name": "Jim Culver",         "role": "The Musician",               "class": "Mystic",   "expansion": "The Dunwich Legacy" },
  { "name": "Ashcan Pete",        "role": "The Drifter",                "class": "Survivor", "expansion": "The Dunwich Legacy" },
  { "name": "Lola Hayes",         "role": "The Actress",                "class": "Neutral",  "expansion": "The Path to Carcosa" },
  { "name": "Leo Anderson",       "role": "The Expedition Leader",      "class": "Guardian", "expansion": "The Forgotten Age" },
  { "name": "Ursula Downs",       "role": "The Explorer",               "class": "Seeker",   "expansion": "The Forgotten Age" },
  { "name": "Finn Edwards",       "role": "The Bootlegger",             "class": "Rogue",    "expansion": "The Forgotten Age" },
  { "name": "Father Mateo",       "role": "The Priest",                 "class": "Mystic",   "expansion": "The Forgotten Age" },
  { "name": "Calvin Wright",      "role": "The Haunted",                "class": "Survivor", "expansion": "The Forgotten Age" },
  { "name": "Carolyn Fern",       "role": "The Psychologist",           "class": "Guardian", "expansion": "The Circle Undone" },
  { "name": "Joe Diamond",        "role": "The Private Investigator",   "class": "Seeker",   "expansion": "The Circle Undone" },
  { "name": "Preston Fairmont",   "role": "The Millionaire",            "class": "Rogue",    "expansion": "The Circle Undone" },
  { "name": "Diana Stanley",      "role": "The Redeemed Cultist",       "class": "Mystic",   "expansion": "The Circle Undone" },
  { "name": "Rita Young",         "role": "The Athlete",                "class": "Survivor", "expansion": "The Circle Undone" },
  { "name": "Marie Lambeau",      "role": "The Entertainer",            "class": "Mystic",   "expansion": "The Circle Undone" },
  { "name": "Sister Mary",        "role": "The Nun",                    "class": "Guardian", "expansion": "The Innsmouth Conspiracy" },
  { "name": "Amanda Sharpe",      "role": "The Student",                "class": "Seeker",   "expansion": "The Innsmouth Conspiracy" },
  { "name": "Trish Scarborough",  "role": "The Spy",                    "class": "Rogue",    "expansion": "The Innsmouth Conspiracy" },
  { "name": "Dexter Drake",       "role": "The Magician",               "class": "Mystic",   "expansion": "The Innsmouth Conspiracy" },
  { "name": "Silas Marsh",        "role": "The Sailor ",                "class": "Survivor", "expansion": "The Innsmouth Conspiracy" },
  { "name": "Daniela Reyes",      "role": "The Mechanic",               "class": "Guardian", "expansion": "Edge of the Earth" },
  { "name": "Norman Withers",     "role": "The Astronomer",             "class": "Seeker",   "expansion": "Edge of the Earth" },
  { "name": "Monterey Jack",      "role": "The Archaeologist",          "class": "Rogue",    "expansion": "Edge of the Earth" },
  { "name": "Lily Chen",          "role": "The Martial Artist",         "class": "Mystic",   "expansion": "Edge of the Earth" },
  { "name": "Bob Jenkins",        "role": "The Salesman",               "class": "Survivor", "expansion": "Edge of the Earth" },
  { "name": "Carson Sinclair",    "role": "The Butler",                 "class": "Guardian", "expansion": "The Scarlet Keys" },
  { "name": "Vincent Lee",        "role": "The Doctor",                 "class": "Seeker",   "expansion": "The Scarlet Keys" },
  { "name": "Kymani Jones",       "role": "The Security Consultant",    "class": "Rogue",    "expansion": "The Scarlet Keys" },
  { "name": "Amina Zidane",       "role": "The Operator",               "class": "Mystic",   "expansion": "The Scarlet Keys" },
  { "name": "Darrell Simmons",    "role": "The Photographer",           "class": "Survivor", "expansion": "The Scarlet Keys" },
  { "name": "Charlie Kane",       "role": "The Politician",             "class": "Neutral",  "expansion": "The Scarlet Keys" },
  { "name": "Wilson Richards",    "role": "The Handyman",               "class": "Guardian", "expansion": "The Feast of Hemlock Vale" },
  { "name": "Kate Winthrop",      "role": "The Scientist",              "class": "Seeker",   "expansion": "The Feast of Hemlock Vale" },
  { "name": "Alessandra Zorzi",   "role": "The Countess",               "class": "Rogue",    "expansion": "The Feast of Hemlock Vale" },
  { "name": "Kōhaku Narukami",    "role": "The Folklorist",             "class": "Mystic",   "expansion": "The Feast of Hemlock Vale" },
  { "name": "Hank Samson",        "role": "The Farmhand",               "class": "Survivor", "expansion": "The Feast of Hemlock Vale" },
  { "name": "Marion Tavares",     "role": "The Trawler",                "class": "Guardian", "expansion": "The Drowned City" },
  { "name": "Lucius Galloway",    "role": "The Poet",                   "class": "Seeker",   "expansion": "The Drowned City" },
  { "name": "Michael McGlen",     "role": "The Gangster",               "class": "Rogue",    "expansion": "The Drowned City" },
  { "name": "Agatha Crane Mystic","role": "The Parapsychologist",       "class": "Mystic",   "expansion": "The Drowned City" },
  { "name": "Agatha Crane Seeker","role": "The Parapsychologist",       "class": "Seeker",   "expansion": "The Drowned City" },
  { "name": "Gloria Goldberg",    "role": "The Writer",                 "class": "Mystic",   "expansion": "The Drowned City" },
  { "name": "George Barnaby",     "role": "The Lawyer",                 "class": "Survivor", "expansion": "The Drowned City" },
  { "name": "Nathaniel Cho",      "role": "The Boxer",                  "class": "Guardian", "expansion": "Investigator Starter Deck" },
  { "name": "Harvey Walters",     "role": "The Professor",              "class": "Seeker",   "expansion": "Investigator Starter Deck" },
  { "name": "Winifred Habbamock", "role": "The Aviatrix",               "class": "Rogue",    "expansion": "Investigator Starter Deck" },
  { "name": "Stella Clark",       "role": "The Letter Carrier",         "class": "Survivor", "expansion": "Investigator Starter Deck" },
  { "name": "Jacqueline Fine",    "role": "The Psychic",                "class": "Mystic",   "expansion": "Investigator Starter Deck" }
  ];

  // ── CONSTANTS ────────────────────────────────────────────────────────────────
  const STORAGE_KEY = 'ahp_picked_v1';

  // ── STATE ────────────────────────────────────────────────────────────────────
  let investigators = [];
  let pickedSet     = new Set();   // confirmed picks only
  let playerCount   = 1;
  let pendingPicks  = null;        // array of inv objects, or null

  // ── PERSISTENCE ──────────────────────────────────────────────────────────────
  function saveState() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify([...pickedSet])); } catch(e) {}
  }
  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) pickedSet = new Set(JSON.parse(raw));
    } catch(e) { pickedSet = new Set(); }
  }

  // ── BOOT ─────────────────────────────────────────────────────────────────────
  function init() {
    investigators = INVESTIGATORS_DATA;
    loadState();
    updateStats();
    renderResults(null);
    renderList();
  }

  // ── PLAYER COUNT ─────────────────────────────────────────────────────────────
  function setPlayers(n) {
    if (pendingPicks) return; // lock during pending state
    playerCount = n;
    document.querySelectorAll('.player-btn').forEach(b => b.classList.toggle('active', +b.dataset.n === n));
    updatePickBtnLabel();
    renderResults(null);
  }

  function updatePickBtnLabel() {
    document.getElementById('btnPick').textContent =
      playerCount === 1 ? 'Pick Investigator' : `Pick ${playerCount} Investigators`;
  }

  // ── HELPERS ──────────────────────────────────────────────────────────────────
  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // Pool = investigators not confirmed AND not currently in pendingPicks (for rerolls)
  function getAvailable(excludeExtra = []) {
    const excluded = new Set([...pickedSet, ...excludeExtra]);
    return investigators.filter(inv => !excluded.has(inv.name));
  }

  // ── PICK / CONFIRM / REDO ────────────────────────────────────────────────────
  function pickInvestigators() {
    if (pendingPicks) return;
    const pool = getAvailable();
    if (pool.length < playerCount) return;
    pendingPicks = shuffle(pool).slice(0, playerCount);
    setConfirmBarVisible(true);
    updatePickBtn();
    renderResults(pendingPicks, true);
  }

  function confirmPick() {
    if (!pendingPicks) return;
    pendingPicks.forEach(inv => pickedSet.add(inv.name));
    pendingPicks = null;
    saveState();
    setConfirmBarVisible(false);
    updateStats();
    updatePickBtn();
    renderResults(null);
    renderList();
  }

  function redoPick() {
    if (!pendingPicks) return;
    pendingPicks = null;
    setConfirmBarVisible(false);
    updatePickBtn();
    renderResults(null);
  }

  // Reroll one card at index i 
  function rerollCard(i) {
    if (!pendingPicks) return;
    // Exclude all other pending picks so no duplicate in the same draw
    const keepNames = pendingPicks.filter((_, idx) => idx !== i).map(p => p.name);
    const pool      = getAvailable(keepNames);
    if (pool.length === 0) return;
    pendingPicks[i] = pool[Math.floor(Math.random() * pool.length)];
    // Only animate/replace the one slot
    const cards = document.getElementById('resultsGrid').querySelectorAll('.result-card');
    if (cards[i]) {
      cards[i].classList.remove('revealed');
      fillCard(cards[i], pendingPicks[i], i, true);
    }
  }

  // ── MANUAL MARK ──────────────────────────────────────────────────────────────
  function toggleMark(name) {
    if (pendingPicks) return;
    pickedSet.has(name) ? pickedSet.delete(name) : pickedSet.add(name);
    saveState();
    updateStats();
    renderList();
  }

  // ── RESET ────────────────────────────────────────────────────────────────────
  function resetPicks() {
    pendingPicks = null;
    pickedSet.clear();
    saveState();
    setConfirmBarVisible(false);
    updateStats();
    updatePickBtn();
    renderResults(null);
    renderList();
  }

  // ── STATS ────────────────────────────────────────────────────────────────────
  function updateStats() {
    const total = investigators.length, picked = pickedSet.size;
    document.getElementById('statTotal').textContent     = total;
    document.getElementById('statPicked').textContent    = picked;
    document.getElementById('statRemaining').textContent = total - picked;
    document.getElementById('progressBar').style.width   = total ? (picked / total * 100) + '%' : '0%';
  }

  function updatePickBtn() {
    const btn  = document.getElementById('btnPick');
    const avail = getAvailable();
    btn.disabled = !!pendingPicks || avail.length < playerCount;
  }

  function setConfirmBarVisible(v) {
    document.getElementById('confirmBar').classList.toggle('visible', v);
  }

  // ── RESULTS GRID ─────────────────────────────────────────────────────────────
  function renderResults(source, animate) {
    const grid = document.getElementById('resultsGrid');
    grid.innerHTML = '';

    for (let i = 0; i < playerCount; i++) {
      const card = document.createElement('div');
      card.className = 'result-card';
      const inv = source ? source[i] : null;
      if (inv) {
        fillCard(card, inv, i, animate);
      } else {
        if (playerCount > 1) card.innerHTML += `<div class="player-label">Player ${i + 1}</div>`;
        card.innerHTML += `<div class="placeholder-text">—</div>`;
      }
      grid.appendChild(card);
    }
  }

  function fillCard(card, inv, i, animate) {
    const isPending = pendingPicks !== null;
    card.className  = `result-card cls-${inv.class}`;
    card.innerHTML  = `
      ${playerCount > 1 ? `<div class="player-label">Player ${i + 1}</div>` : ''}
      ${isPending ? `<button class="reroll-btn" title="Reroll this investigator" onclick="rerollCard(${i})">⟳</button>` : ''}
      <div class="card-name">${inv.name}</div>
      <div class="card-role">${inv.role}</div>
      <div class="card-expansion">${inv.expansion}</div>
    `;
    if (animate) {
      requestAnimationFrame(() => requestAnimationFrame(() => card.classList.add('revealed')));
    } else {
      card.classList.add('revealed');
    }
  }

  // ── ROSTER LIST ──────────────────────────────────────────────────────────────
  function renderList() {
    const filter = document.getElementById('filterInput').value.toLowerCase();
    const list   = document.getElementById('charList');
    list.innerHTML = '';

    // Build ordered expansion groups from data order
    const groups = [], groupMap = {};
    investigators.forEach(inv => {
      if (!groupMap[inv.expansion]) { groupMap[inv.expansion] = []; groups.push(inv.expansion); }
      groupMap[inv.expansion].push(inv);
    });

    let anyVisible = false;
    groups.forEach(expansion => {
      const members = groupMap[expansion].filter(inv =>
        !filter ||
        inv.name.toLowerCase().includes(filter) ||
        inv.role.toLowerCase().includes(filter) ||
        expansion.toLowerCase().includes(filter)
      );
      if (!members.length) return;
      anyVisible = true;

      const hdr = document.createElement('div');
      hdr.className = 'expansion-divider';
      hdr.textContent = expansion;
      list.appendChild(hdr);

      members.forEach(inv => {
        const isPicked = pickedSet.has(inv.name);
        const item = document.createElement('div');
        item.className = 'char-item' + (isPicked ? ' picked' : '');
          item.innerHTML = `
            <div class="char-left">
              <div class="dot dot-${inv.class}"></div>
            <div class="char-info">
              <div class="char-name">${inv.name}</div>
              <div class="char-role">${inv.role}</div>
            </div>
          </div>
          <button class="mark-btn"
            title="${isPicked ? 'Unmark' : 'Mark as picked'}"
              onclick='toggleMark(${JSON.stringify(inv.name)})'
          >${isPicked ? '✓' : '+'}</button>`;
        list.appendChild(item);
      });
    });

    if (!anyVisible) {
      const empty = document.createElement('div');
      empty.style.cssText = 'padding:16px;font-size:0.8rem;color:var(--muted);text-align:center;font-style:italic;';
      empty.textContent = 'No investigators match.';
      list.appendChild(empty);
    }
  }

  // ── START ────────────────────────────────────────────────────────────────────
  init();
</script>
</body>
</html>
