<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arkham Investigator Picker</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css">

</head>
<body>

<header>
  <h1>Arkham Investigator Picker</h1>
  <p>Random selection</p>
  <div class="divider"></div>
</header>

<div class="main-layout">
  <div class="panel">

    <!-- Player count -->
    <div class="player-row">
      <label>Players</label>
      <div class="player-btns">
        <button class="player-btn active" data-n="1" onclick="setPlayers(1)">1</button>
        <button class="player-btn"        data-n="2" onclick="setPlayers(2)">2</button>
        <button class="player-btn"        data-n="3" onclick="setPlayers(3)">3</button>
        <button class="player-btn"        data-n="4" onclick="setPlayers(4)">4</button>
      </div>
    </div>

    <!-- Results -->
    <div class="results-grid" id="resultsGrid"></div>

    <!-- Confirm/Redo bar — hidden until a pending pick exists -->
    <div class="confirm-bar" id="confirmBar">
      <span>Lock in these investigators?</span>
      <button class="btn-redo" onclick="redoPick()">↺ Redo all</button>
      <button class="btn-confirm" onclick="confirmPick()">✓ Confirm</button>
    </div>

    <!-- Stats -->
    <div class="stats">
      <span><strong id="statRemaining">—</strong>Remaining</span>
      <span><strong id="statPicked">—</strong>Picked</span>
      <span><strong id="statTotal">—</strong>Total</span>
    </div>
    <div class="progress-bar-wrap">
      <div class="progress-bar" id="progressBar" style="width:0%"></div>
    </div>

    <!-- Actions -->
    <div class="btn-row">
      <button class="btn-pick" id="btnPick" onclick="pickInvestigators()">Pick Investigator</button>
      <button class="btn-reset" onclick="resetPicks()">↺ Reset</button>
    </div>

  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header"><span>Full Roster</span></div>
    <div class="filter-row">
      <input type="text" id="filterInput" placeholder="Filter investigators…" oninput="renderList()" />
    </div>
    <div class="char-list" id="charList"></div>

    <div class="sidebar-header" style="margin-top:12px;"><span>Pick History</span></div>
    <div id="pickHistory" style="padding:8px;max-height:200px;overflow:auto;font-size:0.9rem;color:var(--muted);"></div>
    <div style="padding:8px 8px 16px;">
      <button class="btn-reset" onclick="clearHistory()" style="width:100%;">Clear History</button>
    </div>
  </div>
</div>

<script src="investigators.js"></script>
<script>
  // ── CONSTANTS ────────────────────────────────────────────────────────────────
  const STORAGE_KEY = 'ahp_picked_v1';
  const HISTORY_KEY = 'ahp_pick_history_v1';

  // ── STATE ────────────────────────────────────────────────────────────────────
  let investigators = [];
  let pickedSet     = new Set();   // confirmed picks only
  let pickHistory   = [];
  let playerCount   = 1;
  let pendingPicks  = null;        // array of inv objects, or null

  function makeId(inv){ return `${inv.name}||${inv.class}`; }

  // ── PERSISTENCE ──────────────────────────────────────────────────────────────
  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...pickedSet]));
      localStorage.setItem(HISTORY_KEY, JSON.stringify(pickHistory));
    } catch(e) {}
  }
  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) pickedSet = new Set(JSON.parse(raw));
      const rawHist = localStorage.getItem(HISTORY_KEY);
      if (rawHist) pickHistory = JSON.parse(rawHist);
    } catch(e) { pickedSet = new Set(); pickHistory = []; }
  }

  // ── BOOT ─────────────────────────────────────────────────────────────────────
  function init() {
    investigators = INVESTIGATORS_DATA;
    loadState();
    updateStats();
    renderResults(null);
    renderList();
    renderHistory();
  }

  // ── PLAYER COUNT ─────────────────────────────────────────────────────────────
  function setPlayers(n) {
    if (pendingPicks) return; // lock during pending state
    playerCount = n;
    document.querySelectorAll('.player-btn').forEach(b => b.classList.toggle('active', +b.dataset.n === n));
    updatePickBtnLabel();
    renderResults(null);
  }

  function updatePickBtnLabel() {
    document.getElementById('btnPick').textContent =
      playerCount === 1 ? 'Pick Investigator' : `Pick ${playerCount} Investigators`;
  }

  // ── HELPERS ──────────────────────────────────────────────────────────────────
  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // Pool = investigators not confirmed AND not currently in pendingPicks (for rerolls)
  function getAvailable(excludeExtra = []) {
    const excluded = new Set([...pickedSet, ...excludeExtra]);
    return investigators.filter(inv => !excluded.has(makeId(inv)));
  }

  // ── PICK / CONFIRM / REDO ────────────────────────────────────────────────────
  function pickInvestigators() {
    if (pendingPicks) return;
    const pool = getAvailable();
    if (pool.length < playerCount) return;
    pendingPicks = shuffle(pool).slice(0, playerCount);
    setConfirmBarVisible(true);
    updatePickBtn();
    renderResults(pendingPicks, true);
  }

  function confirmPick() {
    if (!pendingPicks) return;
    const picks = pendingPicks.map(inv => ({ name: inv.name, class: inv.class }));
    pickHistory.push({ when: Date.now(), players: playerCount, picks });

    pendingPicks.forEach(inv => pickedSet.add(makeId(inv)));
    pendingPicks = null;
    saveState();
    setConfirmBarVisible(false);
    updateStats();
    updatePickBtn();
    renderResults(null);
    renderList();
    renderHistory();
  }

  function redoPick() {
    if (!pendingPicks) return;
    pendingPicks = null;
    setConfirmBarVisible(false);
    updatePickBtn();
    renderResults(null);
  }

  // Reroll one card at index i 
  function rerollCard(i) {
    if (!pendingPicks) return;
    // Exclude all other pending picks so no duplicate in the same draw
    const keepIds = pendingPicks.filter((_, idx) => idx !== i).map(p => makeId(p));
    const pool    = getAvailable(keepIds);
    if (pool.length === 0) return;
    pendingPicks[i] = pool[Math.floor(Math.random() * pool.length)];
    // Only animate/replace the one slot
    const cards = document.getElementById('resultsGrid').querySelectorAll('.result-card');
    if (cards[i]) {
      cards[i].classList.remove('revealed');
      fillCard(cards[i], pendingPicks[i], i, true);
    }
  }

  // ── MANUAL MARK ──────────────────────────────────────────────────────────────
  function toggleMark(id) {
    if (pendingPicks) return;
    pickedSet.has(id) ? pickedSet.delete(id) : pickedSet.add(id);
    saveState();
    updateStats();
    renderList();
  }

  // ── RESET ────────────────────────────────────────────────────────────────────
  function resetPicks() {
    pendingPicks = null;
    pickedSet.clear();
    saveState();
    setConfirmBarVisible(false);
    updateStats();
    updatePickBtn();
    renderResults(null);
    renderList();
  }

  // ── STATS ────────────────────────────────────────────────────────────────────
  function updateStats() {
    const total = investigators.length, picked = pickedSet.size;
    document.getElementById('statTotal').textContent     = total;
    document.getElementById('statPicked').textContent    = picked;
    document.getElementById('statRemaining').textContent = total - picked;
    document.getElementById('progressBar').style.width   = total ? (picked / total * 100) + '%' : '0%';
  }

  function updatePickBtn() {
    const btn  = document.getElementById('btnPick');
    const avail = getAvailable();
    btn.disabled = !!pendingPicks || avail.length < playerCount;
  }

  function setConfirmBarVisible(v) {
    document.getElementById('confirmBar').classList.toggle('visible', v);
  }

  // ── RESULTS GRID ─────────────────────────────────────────────────────────────
  function renderResults(source, animate) {
    const grid = document.getElementById('resultsGrid');
    grid.innerHTML = '';
    grid.dataset.players = playerCount;

    for (let i = 0; i < playerCount; i++) {
      const card = document.createElement('div');
      card.className = 'result-card';
      card.dataset.slot = i;
      card.ondragover = e => e.preventDefault();
      card.ondrop = e => { e.preventDefault(); dropIntoSlot(i, e.dataTransfer.getData('invId')); };
      const inv = source ? source[i] : null;
      if (inv) {
        fillCard(card, inv, i, animate);
      } else {
        if (playerCount > 1) card.innerHTML += `<div class="player-label">Player ${i + 1}</div>`;
        card.innerHTML += `<div class="placeholder-text">—</div>`;
      }
      grid.appendChild(card);
    }
  }

  function dropIntoSlot(slot, invId) {
    const inv = investigators.find(i => makeId(i) === invId);
    if (!inv) return;
    if (!pendingPicks) pendingPicks = Array(playerCount).fill(null);
    pendingPicks[slot] = inv;
    setConfirmBarVisible(true);
    updatePickBtn();
    renderResults(pendingPicks, false);
  }

  function fillCard(card, inv, i, animate) {
    const isPending = pendingPicks !== null;
    card.className  = `result-card cls-${inv.class}`;
    card.innerHTML  = `
      ${playerCount > 1 ? `<div class="player-label">Player ${i + 1}</div>` : ''}
      ${isPending ? `<button class="reroll-btn" title="Reroll this investigator" onclick="rerollCard(${i})">⟳</button>` : ''}
      <div class="card-name">${inv.name}</div>
      <div class="card-role">${inv.role}</div>
      <div class="card-stats">
        <span title="Willpower"><i class="icon">p</i>${inv.willpower}</span>
        <span title="Intellect"><i class="icon">b</i>${inv.intellect}</span>
        <span title="Combat"><i class="icon">c</i>${inv.combat}</span>
        <span title="Agility"><i class="icon">a</i>${inv.agility}</span>
      </div>
      <div class="card-health-sanity">
        <span class="health" title="Health">${inv.health}</span>
        <span class="sanity" title="Sanity">${inv.sanity}</span>
      </div>
      <div class="card-expansion">${inv.expansion}</div>
    `;
    if (animate) {
      requestAnimationFrame(() => requestAnimationFrame(() => card.classList.add('revealed')));
    } else {
      card.classList.add('revealed');
    }
  }

  // ── ROSTER LIST ──────────────────────────────────────────────────────────────
  function renderList() {
    const filter = document.getElementById('filterInput').value.toLowerCase();
    const list   = document.getElementById('charList');
    list.innerHTML = '';

    // Build ordered expansion groups from data order
    const groups = [], groupMap = {};
    investigators.forEach(inv => {
      if (!groupMap[inv.expansion]) { groupMap[inv.expansion] = []; groups.push(inv.expansion); }
      groupMap[inv.expansion].push(inv);
    });

    let anyVisible = false;
    groups.forEach(expansion => {
      const members = groupMap[expansion].filter(inv =>
        !filter ||
        inv.name.toLowerCase().includes(filter) ||
        inv.role.toLowerCase().includes(filter) ||
        inv.class.toLowerCase().includes(filter) ||
        expansion.toLowerCase().includes(filter)
      );
      if (!members.length) return;
      anyVisible = true;

      const hdr = document.createElement('div');
      hdr.className = 'expansion-divider';
      hdr.textContent = expansion;
      list.appendChild(hdr);

      members.forEach(inv => {
        const id = makeId(inv);
        const isPicked = pickedSet.has(id);
        const classIcons = { Guardian: 'f', Seeker: 'h', Rogue: 'd', Mystic: 'g', Survivor: 'e', Neutral: '' };
        const item = document.createElement('div');
        item.className = 'char-item' + (isPicked ? ' picked' : '');
        item.draggable = true;
        item.ondragstart = e => e.dataTransfer.setData('invId', id);
          item.innerHTML = `
            <div class="char-left">
              <div class="dot dot-${inv.class}">${classIcons[inv.class] || ''}</div>
            <div class="char-info">
              <div class="char-name">${inv.name}</div>
              <div class="char-role">${inv.role}</div>
            </div>
          </div>
          <button class="mark-btn"
            title="${isPicked ? 'Unmark' : 'Mark as picked'}"
              onclick='toggleMark(${JSON.stringify(id)})'
          >${isPicked ? '✓' : '+'}</button>`;
        list.appendChild(item);
      });
    });

    if (!anyVisible) {
      const empty = document.createElement('div');
      empty.style.cssText = 'padding:16px;font-size:0.8rem;color:var(--muted);text-align:center;font-style:italic;';
      empty.textContent = 'No investigators match.';
      list.appendChild(empty);
    }
  }

  // ── HISTORY ──────────────────────────────────────────────────────────────────
  function renderHistory() {
    const el = document.getElementById('pickHistory');
    if (!pickHistory.length) { el.innerHTML = '<div style="font-style:italic;">No picks yet</div>'; return; }
    el.innerHTML = pickHistory.slice().reverse().map(h => {
      const date = new Date(h.when).toLocaleString();
      const names = h.picks.map(p => p.name || p).join(', ');
      return `<div style="margin-bottom:8px;"><strong>${date}</strong><br>${names}</div>`;
    }).join('');
  }

  function clearHistory() {
    pickHistory = [];
    saveState();
    renderHistory();
  }

  // ── START ────────────────────────────────────────────────────────────────────
  init();
</script>
</body>
</html>
